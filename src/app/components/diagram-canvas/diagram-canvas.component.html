<div class="canvas-container">
  <!-- Diagram Title Header -->
  <div class="diagram-header">
    <div class="diagram-title">
      {{ getCurrentDiagramTitle() }}
    </div>
  </div>

  <svg
    #canvas
    class="diagram-canvas"
    width="100%"
    height="100%"
    (click)="onCanvasClick($event)">

  <!-- Grid background -->
  <rect
    width="100%"
    height="100%"
    fill="url(#grid)">
  </rect>

  <!-- Bounding boxes - bottom layer -->
  <g class="bounding-boxes">
    <g
      *ngFor="let box of getBoundingBoxes()"
      class="bounding-box-group"
      cdkDrag
      (cdkDragStarted)="onBoundingBoxDragStarted(box)"
      (cdkDragMoved)="onBoundingBoxDragMoved($event, box)"
      (cdkDragEnded)="onBoundingBoxDragEnd($event, box)"
      (click)="onBoundingBoxClick($event, box)"
      (contextmenu)="onBoundingBoxContextMenu($event, box)">

      <!-- Bounding box rectangle -->
      <rect
        [attr.x]="box.position.x"
        [attr.y]="box.position.y"
        [attr.width]="box.size.width"
        [attr.height]="box.size.height"
        [attr.fill]="box.fillColor"
        [attr.stroke]="box.borderColor"
        stroke-width="2"
        stroke-dasharray="8,4"
        class="bounding-box">
      </rect>

      <!-- Resize handle -->
      <circle
        *ngIf="state.selectedBoundingBoxId === box.id"
        [attr.cx]="box.position.x + box.size.width"
        [attr.cy]="box.position.y + box.size.height"
        r="4"
        class="resize-handle"
        (mousedown)="startBoundingBoxResize($event, box, 'se')"
        style="cursor: nw-resize;">
      </circle>

      <!-- Bounding box label -->
      <text
        [attr.x]="box.position.x + box.size.width - 10"
        [attr.y]="box.position.y + 20"
        text-anchor="end"
        dominant-baseline="hanging"
        class="bounding-box-label">
        {{ box.label }}
      </text>
    </g>
  </g>

  <!-- SVG Images -->
  <g class="svg-images">
    <g
      *ngFor="let svgImage of getSvgImages()"
      class="svg-image-group"
      cdkDrag
      (cdkDragEnded)="onSvgImageDragEnd($event, svgImage)"
      (click)="onSvgImageClick($event, svgImage)"
      (contextmenu)="onSvgImageContextMenu($event, svgImage)">

      <!-- SVG content -->
      <g [innerHTML]="sanitizeSvgContent(svgImage.svgContent)"
         [attr.transform]="'translate(' + svgImage.position.x + ',' + svgImage.position.y + ')'">
      </g>

      <!-- Bounding box for SVG (invisible but for selection) -->
      <rect
        [attr.x]="svgImage.position.x"
        [attr.y]="svgImage.position.y"
        [attr.width]="svgImage.size.width"
        [attr.height]="svgImage.size.height"
        fill="transparent"
        stroke="transparent"
        class="svg-image-bounds">
      </rect>

      <!-- Resize handle -->
      <circle
        *ngIf="state.selectedSvgImageId === svgImage.id"
        [attr.cx]="svgImage.position.x + svgImage.size.width"
        [attr.cy]="svgImage.position.y + svgImage.size.height"
        r="4"
        class="resize-handle"
        (mousedown)="startSvgImageResize($event, svgImage, 'se')"
        style="cursor: nw-resize;">
      </circle>

      <!-- SVG Image Label -->
      <text
        *ngIf="svgImage.label"
        [attr.x]="svgImage.position.x + svgImage.size.width / 2"
        [attr.y]="svgImage.position.y + svgImage.size.height + 20"
        text-anchor="middle"
        dominant-baseline="hanging"
        class="svg-image-label">
        {{ svgImage.label }}
      </text>

      <!-- Tendrils for SVG image -->
      <g class="svg-tendrils">
        <ng-container *ngFor="let tendril of svgImage.tendrils">
          <g
            class="svg-tendril-group"
            *ngIf="!hasEdgeName(svgImage.id, tendril.id)">

            <!-- Invisible larger click area -->
            <rect
              [attr.x]="tendril.type === 'incoming' ? svgImage.position.x + tendril.position.x - 35 : svgImage.position.x + tendril.position.x - 15"
              [attr.y]="svgImage.position.y + tendril.position.y - 20"
              [attr.width]="tendril.type === 'incoming' ? 55 : 55"
              [attr.height]="40"
              fill="transparent"
              (click)="onSvgTendrilClick($event, svgImage, tendril)"
              (contextmenu)="onSvgTendrilContextMenu($event, svgImage, tendril)"
              class="tendril-click-area">
            </rect>

            <!-- Tendril circles -->
            <circle
              [attr.cx]="svgImage.position.x + tendril.position.x"
              [attr.cy]="svgImage.position.y + tendril.position.y"
              r="5"
              [attr.fill]="tendril.type === 'incoming' ? '#4CAF50' : '#FF5722'"
              [attr.stroke]="'#ffffff'"
              stroke-width="1"
              class="tendril"
              (click)="onSvgTendrilClick($event, svgImage, tendril)"
              (contextmenu)="onSvgTendrilContextMenu($event, svgImage, tendril)"
              style="cursor: pointer;">
            </circle>

            <!-- Tendril name -->
            <text
              [attr.x]="tendril.position.x < svgImage.size.width / 2 ? svgImage.position.x + tendril.position.x - 25 : svgImage.position.x + tendril.position.x + 25"
              [attr.y]="svgImage.position.y + tendril.position.y - 8"
              [attr.text-anchor]="tendril.position.x < svgImage.size.width / 2 ? 'end' : 'start'"
              dominant-baseline="middle"
              class="tendril-name"
              (click)="onSvgTendrilClick($event, svgImage, tendril)"
              (contextmenu)="onSvgTendrilContextMenu($event, svgImage, tendril)"
              style="cursor: pointer;">
              {{ tendril.name }}
            </text>
          </g>
        </ng-container>
      </g>
    </g>
  </g>

  <!-- Edges -->
  <g class="edges">
    <g *ngFor="let edge of getCurrentEdges()" class="edge-group">
      <path
        [attr.d]="getEdgePath(edge)"
        class="edge"
        [class.selected]="state.selectedEdgeId === edge.id"
        stroke="#666"
        stroke-width="2"
        fill="none"
        marker-end="url(#arrowhead)"
        (click)="onEdgeClick($event, edge)">
      </path>
      <!-- Edge name label -->
      <text
        *ngIf="edge.name"
        [attr.x]="getEdgeLabelPosition(edge).x"
        [attr.y]="getEdgeLabelPosition(edge).y"
        text-anchor="middle"
        dominant-baseline="middle"
        class="edge-name">
        {{ edge.name }}
      </text>
    </g>
  </g>

  <!-- Temporary edge during creation -->
  <path
    *ngIf="isCreatingEdge"
    [attr.d]="getTempEdgePath()"
    class="temp-edge"
    stroke="#999"
    stroke-width="2"
    stroke-dasharray="5,5"
    fill="none">
  </path>

  <!-- Nodes -->
  <g class="nodes">
    <g
      *ngFor="let node of getCurrentNodes()"
      class="node-group"
      cdkDrag
      (cdkDragEnded)="onNodeDragEnd($event, node)"
      (click)="onNodeClick($event, node)"
      (dblclick)="onNodeDoubleClick(node)"
      (contextmenu)="onNodeContextMenu($event, node)">

      <!-- Node shapes -->
      <rect
        *ngIf="node.shape === 'rectangle'"
        [attr.x]="node.position.x"
        [attr.y]="node.position.y"
        [attr.width]="node.size.width"
        [attr.height]="node.size.height"
        [attr.fill]="node.fillColor"
        [attr.stroke]="node.borderColor"
        stroke-width="2"
        filter="url(#dropshadow)"
        [class.highlighted]="isHighlighted('node', node.id)"
        class="node">
      </rect>

      <circle
        *ngIf="node.shape === 'circle'"
        [attr.cx]="node.position.x + node.size.width / 2"
        [attr.cy]="node.position.y + node.size.height / 2"
        [attr.r]="getCircleRadius(node)"
        [attr.fill]="node.fillColor"
        [attr.stroke]="node.borderColor"
        stroke-width="2"
        filter="url(#dropshadow)"
        [class.highlighted]="isHighlighted('node', node.id)"
        class="node">
      </circle>

      <rect
        *ngIf="node.shape === 'pill'"
        [attr.x]="node.position.x"
        [attr.y]="node.position.y"
        [attr.width]="node.size.width"
        [attr.height]="node.size.height"
        [attr.rx]="node.size.height / 2"
        [attr.ry]="node.size.height / 2"
        [attr.fill]="node.fillColor"
        [attr.stroke]="node.borderColor"
        stroke-width="2"
        filter="url(#dropshadow)"
        [class.highlighted]="isHighlighted('node', node.id)"
        class="node">
      </rect>

      <g *ngIf="node.shape === 'cylinder'" [class.highlighted]="isHighlighted('node', node.id)" class="cylinder" filter="url(#dropshadow)">
        <!-- Database cylinder - bottom ellipse -->
        <ellipse
          [attr.cx]="node.position.x + node.size.width / 2"
          [attr.cy]="node.position.y + node.size.height - 8"
          [attr.rx]="node.size.width / 2"
          [attr.ry]="8"
          [attr.fill]="node.fillColor"
          [attr.stroke]="node.borderColor"
          stroke-width="2">
        </ellipse>
        <!-- Database cylinder - body -->
        <rect
          [attr.x]="node.position.x"
          [attr.y]="node.position.y + 8"
          [attr.width]="node.size.width"
          [attr.height]="node.size.height - 16"
          [attr.fill]="node.fillColor"
          [attr.stroke]="node.borderColor"
          stroke-width="2">
        </rect>
        <!-- Database cylinder - top ellipse (smaller) -->
        <ellipse
          [attr.cx]="node.position.x + node.size.width / 2"
          [attr.cy]="node.position.y + 8"
          [attr.rx]="node.size.width / 3"
          [attr.ry]="8"
          [attr.fill]="node.fillColor"
          [attr.stroke]="node.borderColor"
          stroke-width="2">
        </ellipse>
        <!-- Horizontal lines for database tapes -->
        <line
          *ngFor="let i of [1,2,3]"
          [attr.x1]="node.position.x"
          [attr.y1]="node.position.y + 8 + (node.size.height - 16) * i / 4"
          [attr.x2]="node.position.x + node.size.width"
          [attr.y2]="node.position.y + 8 + (node.size.height - 16) * i / 4"
          [attr.stroke]="node.borderColor"
          stroke-width="1">
        </line>
      </g>

      <!-- Diamond shape for decision -->
      <polygon
        *ngIf="node.shape === 'diamond'"
        [attr.points]="getDiamondPoints(node)"
        [attr.fill]="node.fillColor"
        [attr.stroke]="node.borderColor"
        stroke-width="2"
        filter="url(#dropshadow)"
        [class.highlighted]="isHighlighted('node', node.id)"
        class="node">
      </polygon>

      <!-- Parallelogram shape for input/output -->
      <polygon
        *ngIf="node.shape === 'parallelogram'"
        [attr.points]="getParallelogramPoints(node)"
        [attr.fill]="node.fillColor"
        [attr.stroke]="node.borderColor"
        stroke-width="2"
        filter="url(#dropshadow)"
        [class.highlighted]="isHighlighted('node', node.id)"
        class="node">
      </polygon>

      <!-- Document shape -->
      <g *ngIf="node.shape === 'document'" [class.highlighted]="isHighlighted('node', node.id)" class="document" filter="url(#dropshadow)">
        <!-- Document rectangle -->
        <rect
          [attr.x]="node.position.x"
          [attr.y]="node.position.y"
          [attr.width]="node.size.width"
          [attr.height]="node.size.height - 15"
          [attr.fill]="node.fillColor"
          [attr.stroke]="node.borderColor"
          stroke-width="2">
        </rect>
        <!-- Document wavy bottom -->
        <path
          [attr.d]="getDocumentBottomPath(node)"
          [attr.fill]="node.fillColor"
          [attr.stroke]="node.borderColor"
          stroke-width="2">
        </path>
      </g>

      <!-- Rounded rectangle shape -->
      <rect
        *ngIf="node.shape === 'roundedRectangle'"
        [attr.x]="node.position.x"
        [attr.y]="node.position.y"
        [attr.width]="node.size.width"
        [attr.height]="node.size.height"
        [attr.rx]="10"
        [attr.ry]="10"
        [attr.fill]="node.fillColor"
        [attr.stroke]="node.borderColor"
        stroke-width="2"
        filter="url(#dropshadow)"
        [class.highlighted]="isHighlighted('node', node.id)"
        class="node">
      </rect>

      <!-- Hexagon shape for preparation -->
      <polygon
        *ngIf="node.shape === 'hexagon'"
        [attr.points]="getHexagonPoints(node)"
        [attr.fill]="node.fillColor"
        [attr.stroke]="node.borderColor"
        stroke-width="2"
        filter="url(#dropshadow)"
        [class.highlighted]="isHighlighted('node', node.id)"
        class="node">
      </polygon>

      <!-- Triangle shape for manual operation -->
      <polygon
        *ngIf="node.shape === 'triangle'"
        [attr.points]="getTrianglePoints(node)"
        [attr.fill]="node.fillColor"
        [attr.stroke]="node.borderColor"
        stroke-width="2"
        filter="url(#dropshadow)"
        [class.highlighted]="isHighlighted('node', node.id)"
        class="node">
      </polygon>

      <!-- Trapezoid shape for manual input -->
      <polygon
        *ngIf="node.shape === 'trapezoid'"
        [attr.points]="getTrapezoidPoints(node)"
        [attr.fill]="node.fillColor"
        [attr.stroke]="node.borderColor"
        stroke-width="2"
        filter="url(#dropshadow)"
        [class.highlighted]="isHighlighted('node', node.id)"
        class="node">
      </polygon>

      <!-- Text-only node (no shape, just text) -->
      <g *ngIf="node.shape === 'text'" [class.highlighted]="isHighlighted('node', node.id)" class="text-node">
        <!-- Invisible background for selection and interaction -->
        <rect
          [attr.x]="node.position.x"
          [attr.y]="node.position.y"
          [attr.width]="node.size.width"
          [attr.height]="node.size.height"
          fill="transparent"
          stroke="transparent"
          class="text-node-background">
        </rect>
      </g>

      <!-- Stickman shape -->
      <g *ngIf="node.shape === 'stickman'" [class.highlighted]="isHighlighted('node', node.id)" class="stickman" filter="url(#dropshadow)">
        <!-- Head -->
        <circle
          [attr.cx]="node.position.x + node.size.width / 2"
          [attr.cy]="node.position.y + node.size.height * 0.15"
          [attr.r]="node.size.width * 0.12"
          [attr.fill]="node.fillColor"
          [attr.stroke]="node.borderColor"
          stroke-width="2">
        </circle>
        <!-- Body -->
        <line
          [attr.x1]="node.position.x + node.size.width / 2"
          [attr.y1]="node.position.y + node.size.height * 0.27"
          [attr.x2]="node.position.x + node.size.width / 2"
          [attr.y2]="node.position.y + node.size.height * 0.6"
          [attr.stroke]="node.borderColor"
          stroke-width="2">
        </line>
        <!-- Arms -->
        <line
          [attr.x1]="node.position.x + node.size.width * 0.3"
          [attr.y1]="node.position.y + node.size.height * 0.4"
          [attr.x2]="node.position.x + node.size.width * 0.7"
          [attr.y2]="node.position.y + node.size.height * 0.4"
          [attr.stroke]="node.borderColor"
          stroke-width="2">
        </line>
        <!-- Left leg -->
        <line
          [attr.x1]="node.position.x + node.size.width / 2"
          [attr.y1]="node.position.y + node.size.height * 0.6"
          [attr.x2]="node.position.x + node.size.width * 0.35"
          [attr.y2]="node.position.y + node.size.height * 0.9"
          [attr.stroke]="node.borderColor"
          stroke-width="2">
        </line>
        <!-- Right leg -->
        <line
          [attr.x1]="node.position.x + node.size.width / 2"
          [attr.y1]="node.position.y + node.size.height * 0.6"
          [attr.x2]="node.position.x + node.size.width * 0.65"
          [attr.y2]="node.position.y + node.size.height * 0.9"
          [attr.stroke]="node.borderColor"
          stroke-width="2">
        </line>
      </g>

      <!-- Callout shape -->
      <g *ngIf="node.shape === 'callout'" [class.highlighted]="isHighlighted('node', node.id)" class="callout" filter="url(#dropshadow)">
        <!-- Callout bubble -->
        <rect
          [attr.x]="node.position.x"
          [attr.y]="node.position.y"
          [attr.width]="node.size.width * 0.8"
          [attr.height]="node.size.height * 0.8"
          [attr.rx]="10"
          [attr.ry]="10"
          [attr.fill]="node.fillColor"
          [attr.stroke]="node.borderColor"
          stroke-width="2">
        </rect>
        <!-- Callout pointer/tail -->
        <polygon
          [attr.points]="getCalloutPointerPoints(node)"
          [attr.fill]="node.fillColor"
          [attr.stroke]="node.borderColor"
          stroke-width="2">
        </polygon>
      </g>

      <!-- Process shape (rectangle with double border) -->
      <g *ngIf="node.shape === 'process'" [class.highlighted]="isHighlighted('node', node.id)" class="process" filter="url(#dropshadow)">
        <!-- Outer rectangle -->
        <rect
          [attr.x]="node.position.x"
          [attr.y]="node.position.y"
          [attr.width]="node.size.width"
          [attr.height]="node.size.height"
          [attr.fill]="node.fillColor"
          [attr.stroke]="node.borderColor"
          stroke-width="3">
        </rect>
        <!-- Inner rectangle -->
        <rect
          [attr.x]="node.position.x + 3"
          [attr.y]="node.position.y + 3"
          [attr.width]="node.size.width - 6"
          [attr.height]="node.size.height - 6"
          fill="none"
          [attr.stroke]="node.borderColor"
          stroke-width="1">
        </rect>
      </g>

      <!-- Tape shape (magnetic tape reel) -->
      <g *ngIf="node.shape === 'tape'" [class.highlighted]="isHighlighted('node', node.id)" class="tape" filter="url(#dropshadow)">
        <!-- Outer circle -->
        <circle
          [attr.cx]="node.position.x + node.size.width / 2"
          [attr.cy]="node.position.y + node.size.height / 2"
          [attr.r]="getTapeRadius(node)"
          [attr.fill]="node.fillColor"
          [attr.stroke]="node.borderColor"
          stroke-width="2">
        </circle>
        <!-- Inner circle -->
        <circle
          [attr.cx]="node.position.x + node.size.width / 2"
          [attr.cy]="node.position.y + node.size.height / 2"
          [attr.r]="getTapeInnerRadius(node)"
          fill="none"
          [attr.stroke]="node.borderColor"
          stroke-width="2">
        </circle>
        <!-- Tape lines -->
        <line
          *ngFor="let i of [0,1,2,3,4,5]"
          [attr.x1]="node.position.x + node.size.width / 2"
          [attr.y1]="node.position.y + node.size.height / 2"
          [attr.x2]="getTapeLineX2(node, i)"
          [attr.y2]="getTapeLineY2(node, i)"
          [attr.stroke]="node.borderColor"
          stroke-width="1">
        </line>
      </g>

      <!-- Cube shape (3D perspective) -->
      <g *ngIf="node.shape === 'cube'" [class.highlighted]="isHighlighted('node', node.id)" class="cube" filter="url(#dropshadow)">
        <!-- Front face -->
        <rect
          [attr.x]="node.position.x + node.size.width * 0.1"
          [attr.y]="node.position.y + node.size.height * 0.1"
          [attr.width]="node.size.width * 0.8"
          [attr.height]="node.size.height * 0.8"
          [attr.fill]="node.fillColor"
          [attr.stroke]="node.borderColor"
          stroke-width="2">
        </rect>
        <!-- Top face -->
        <polygon
          [attr.points]="getCubeTopFacePoints(node)"
          [attr.fill]="node.fillColor"
          [attr.stroke]="node.borderColor"
          stroke-width="2"
          opacity="0.8">
        </polygon>
        <!-- Side face -->
        <polygon
          [attr.points]="getCubeSideFacePoints(node)"
          [attr.fill]="node.fillColor"
          [attr.stroke]="node.borderColor"
          stroke-width="2"
          opacity="0.6">
        </polygon>
      </g>

      <!-- Resize handles -->
      <circle
        *ngIf="state.selectedNodeId === node.id"
        [attr.cx]="node.position.x + node.size.width"
        [attr.cy]="node.position.y + node.size.height"
        r="4"
        class="resize-handle"
        (mousedown)="startResize($event, node, 'se')"
        style="cursor: nw-resize;">
      </circle>

      <!-- Node name -->
      <text
        [attr.x]="node.shape === 'text' ? node.position.x + 5 : node.position.x + node.size.width / 2"
        [attr.y]="getNodeTextY(node)"
        [attr.text-anchor]="node.shape === 'text' ? 'start' : 'middle'"
        [attr.dominant-baseline]="getNodeTextBaseline(node)"
        class="node-name">
        {{ node.name }}
      </text>

      <!-- Node name label (below shape) -->
      <text
        *ngIf="!['pill', 'rectangle', 'process'].includes(node.shape)"
        [attr.x]="node.position.x + node.size.width / 2"
        [attr.y]="node.position.y + node.size.height + 25"
        text-anchor="middle"
        dominant-baseline="hanging"
        class="node-name-label">
        {{ node.name }}
      </text>

      <!-- Tendrils -->
      <g class="tendrils">
        <ng-container *ngFor="let tendril of node.tendrils">
          <g
            class="tendril-group"
            *ngIf="!hasEdgeName(node.id, tendril.id)">

            <!-- Invisible larger click area -->
            <rect
              [attr.x]="tendril.type === 'incoming' ? node.position.x + tendril.position.x - 30 : node.position.x + tendril.position.x - 10"
              [attr.y]="node.position.y + tendril.position.y - 15"
              [attr.width]="tendril.type === 'incoming' ? 45 : 45"
              [attr.height]="30"
              fill="transparent"
              (click)="onTendrilClick($event, node, tendril)"
              (contextmenu)="onTendrilContextMenu($event, node, tendril)"
              class="tendril-click-area">
            </rect>

            <!-- Tendril circles -->
            <circle
              [attr.cx]="node.position.x + tendril.position.x"
              [attr.cy]="node.position.y + tendril.position.y"
              r="5"
              [attr.fill]="tendril.type === 'incoming' ? '#4CAF50' : '#FF5722'"
              [attr.stroke]="'#ffffff'"
              stroke-width="1"
              [attr.title]="tendril.type === 'incoming' ? 'Incoming Tendril' : 'Outgoing Tendril'"
              class="tendril"
              (click)="onTendrilClick($event, node, tendril)"
              (contextmenu)="onTendrilContextMenu($event, node, tendril)"
              style="cursor: pointer;">
            </circle>

            <!-- Tendril name -->
            <text
              [attr.x]="tendril.position.x < node.size.width / 2 ? node.position.x + tendril.position.x - 25 : node.position.x + tendril.position.x + 25"
              [attr.y]="node.position.y + tendril.position.y - 8"
              [attr.text-anchor]="tendril.position.x < node.size.width / 2 ? 'end' : 'start'"
              dominant-baseline="middle"
              class="tendril-name"
              (click)="onTendrilClick($event, node, tendril)"
              (contextmenu)="onTendrilContextMenu($event, node, tendril)"
              style="cursor: pointer;">
              {{ tendril.name }}
            </text>
          </g>
        </ng-container>

        <!-- Propagated tendrils from inner diagram -->
        <ng-container *ngFor="let tendril of getPropagatedTendrils(node); let i = index">
          <g
            class="propagated-tendril-group"
            *ngIf="!hasPropagatedEdgeName(node.id, tendril.id)">

            <!-- Position propagated tendrils around the node perimeter -->
            <ng-container *ngIf="getPropagatedTendrilPosition(node, i) as pos">
              <!-- Invisible larger click area -->
              <rect
                [attr.x]="tendril.type === 'incoming' ? pos.x - 30 : pos.x - 10"
                [attr.y]="pos.y - 15"
                [attr.width]="tendril.type === 'incoming' ? 45 : 45"
                [attr.height]="30"
                fill="transparent"
                (click)="onPropagatedTendrilClick($event, node, tendril)"
                (contextmenu)="onPropagatedTendrilContextMenu($event, node, tendril)"
                class="tendril-click-area">
              </rect>

              <!-- Tendril circles -->
              <circle
                [attr.cx]="pos.x"
                [attr.cy]="pos.y"
                r="5"
                [attr.fill]="tendril.type === 'incoming' ? '#4CAF50' : '#FF5722'"
                [attr.stroke]="'#ffffff'"
                stroke-width="1"
                [attr.title]="tendril.name"
                class="propagated-tendril"
                (click)="onPropagatedTendrilClick($event, node, tendril)"
                (contextmenu)="onPropagatedTendrilContextMenu($event, node, tendril)"
                style="cursor: pointer;">
              </circle>

              <!-- Tendril name -->
              <text
                [attr.x]="pos.x < node.position.x + node.size.width / 2 ? pos.x - 25 : pos.x + 25"
                [attr.y]="pos.y - 8"
                [attr.text-anchor]="pos.x < node.position.x + node.size.width / 2 ? 'end' : 'start'"
                dominant-baseline="middle"
                class="propagated-tendril-name"
                (click)="onPropagatedTendrilClick($event, node, tendril)"
                (contextmenu)="onPropagatedTendrilContextMenu($event, node, tendril)"
                style="cursor: pointer;">
                {{ tendril.name }}
              </text>
            </ng-container>
          </g>
        </ng-container>
      </g>
    </g>
  </g>

  <!-- Arrow marker, grid pattern, and drop shadow filter definitions -->
  <defs>
    <marker
      id="arrowhead"
      markerWidth="10"
      markerHeight="7"
      refX="9"
      refY="3.5"
      orient="auto">
      <polygon
        points="0 0, 10 3.5, 0 7"
        fill="#666" />
    </marker>

    <pattern
      id="grid"
      width="20"
      height="20"
      patternUnits="userSpaceOnUse">
      <circle
        cx="10"
        cy="10"
        r="1"
        fill="#cccccc">
      </circle>
    </pattern>

    <filter
      id="dropshadow"
      x="-20%"
      y="-20%"
      width="140%"
      height="140%">
      <feDropShadow
        dx="3"
        dy="3"
        stdDeviation="2"
        flood-color="#000000"
        flood-opacity="0.3"/>
    </filter>

    <filter
      id="glow"
      x="-50%"
      y="-50%"
      width="200%"
      height="200%">
      <feGaussianBlur
        stdDeviation="3"
        result="coloredBlur"/>
      <feMerge>
        <feMergeNode in="coloredBlur"/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>
  </defs>
</svg>
</div>
