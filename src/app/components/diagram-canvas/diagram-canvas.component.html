<div class="canvas-container">
  <!-- Diagram Title Header -->
  <div class="diagram-header">
    <div class="diagram-title">
      {{ getCurrentDiagramTitle() }}
    </div>
  </div>

  <svg
    #canvas
    class="diagram-canvas"
    width="100%"
    height="100%"
    (click)="onCanvasClick($event)">

  <!-- Grid background -->
  <rect
    width="100%"
    height="100%"
    fill="url(#grid)">
  </rect>

  <!-- Bounding boxes - bottom layer -->
  <g class="bounding-boxes">
    <g
      *ngFor="let box of getBoundingBoxes()"
      class="bounding-box-group"
      cdkDrag
      (cdkDragStarted)="onBoundingBoxDragStarted(box)"
      (cdkDragMoved)="onBoundingBoxDragMoved($event, box)"
      (cdkDragEnded)="onBoundingBoxDragEnd($event, box)"
      (click)="onBoundingBoxClick($event, box)"
      (contextmenu)="onBoundingBoxContextMenu($event, box)">

      <!-- Bounding box rectangle -->
      <rect
        [attr.x]="box.position.x"
        [attr.y]="box.position.y"
        [attr.width]="box.size.width"
        [attr.height]="box.size.height"
        [attr.fill]="box.fillColor"
        [attr.stroke]="box.borderColor"
        stroke-width="2"
        stroke-dasharray="8,4"
        class="bounding-box">
      </rect>

      <!-- Resize handle -->
      <circle
        *ngIf="state.selectedBoundingBoxId === box.id"
        [attr.cx]="box.position.x + box.size.width"
        [attr.cy]="box.position.y + box.size.height"
        r="4"
        class="resize-handle"
        (mousedown)="startBoundingBoxResize($event, box, 'se')"
        style="cursor: nw-resize;">
      </circle>

      <!-- Bounding box label -->
      <text
        [attr.x]="box.position.x + box.size.width - 10"
        [attr.y]="box.position.y + 20"
        text-anchor="end"
        dominant-baseline="hanging"
        class="bounding-box-label">
        {{ box.label }}
      </text>
    </g>
  </g>

  <!-- Edges -->
  <g class="edges">
    <g *ngFor="let edge of getCurrentEdges()" class="edge-group">
      <path
        [attr.d]="getEdgePath(edge)"
        class="edge"
        [class.selected]="state.selectedEdgeId === edge.id"
        stroke="#666"
        stroke-width="2"
        fill="none"
        marker-end="url(#arrowhead)"
        (click)="onEdgeClick($event, edge)">
      </path>
      <!-- Edge name label -->
      <text
        *ngIf="edge.name"
        [attr.x]="getEdgeLabelPosition(edge).x"
        [attr.y]="getEdgeLabelPosition(edge).y"
        text-anchor="middle"
        dominant-baseline="middle"
        class="edge-name">
        {{ edge.name }}
      </text>
    </g>
  </g>

  <!-- Temporary edge during creation -->
  <path
    *ngIf="isCreatingEdge"
    [attr.d]="getTempEdgePath()"
    class="temp-edge"
    stroke="#999"
    stroke-width="2"
    stroke-dasharray="5,5"
    fill="none">
  </path>

  <!-- Nodes -->
  <g class="nodes">
    <g
      *ngFor="let node of getCurrentNodes()"
      class="node-group"
      cdkDrag
      (cdkDragEnded)="onNodeDragEnd($event, node)"
      (dblclick)="onNodeDoubleClick(node)"
      (contextmenu)="onNodeContextMenu($event, node)">

      <!-- Node shapes -->
      <rect
        *ngIf="node.shape === 'rectangle'"
        [attr.x]="node.position.x"
        [attr.y]="node.position.y"
        [attr.width]="node.size.width"
        [attr.height]="node.size.height"
        [attr.fill]="node.fillColor"
        [attr.stroke]="node.borderColor"
        stroke-width="2"
        filter="url(#dropshadow)"
        [class.highlighted]="isHighlighted('node', node.id)"
        class="node">
      </rect>

      <circle
        *ngIf="node.shape === 'circle'"
        [attr.cx]="node.position.x + node.size.width / 2"
        [attr.cy]="node.position.y + node.size.height / 2"
        [attr.r]="getCircleRadius(node)"
        [attr.fill]="node.fillColor"
        [attr.stroke]="node.borderColor"
        stroke-width="2"
        filter="url(#dropshadow)"
        [class.highlighted]="isHighlighted('node', node.id)"
        class="node">
      </circle>

      <rect
        *ngIf="node.shape === 'pill'"
        [attr.x]="node.position.x"
        [attr.y]="node.position.y"
        [attr.width]="node.size.width"
        [attr.height]="node.size.height"
        [attr.rx]="node.size.height / 2"
        [attr.ry]="node.size.height / 2"
        [attr.fill]="node.fillColor"
        [attr.stroke]="node.borderColor"
        stroke-width="2"
        filter="url(#dropshadow)"
        [class.highlighted]="isHighlighted('node', node.id)"
        class="node">
      </rect>

      <g *ngIf="node.shape === 'cylinder'" [class.highlighted]="isHighlighted('node', node.id)" class="cylinder" filter="url(#dropshadow)">
        <!-- Database cylinder - bottom ellipse -->
        <ellipse
          [attr.cx]="node.position.x + node.size.width / 2"
          [attr.cy]="node.position.y + node.size.height - 8"
          [attr.rx]="node.size.width / 2"
          [attr.ry]="8"
          [attr.fill]="node.fillColor"
          [attr.stroke]="node.borderColor"
          stroke-width="2">
        </ellipse>
        <!-- Database cylinder - body -->
        <rect
          [attr.x]="node.position.x"
          [attr.y]="node.position.y + 8"
          [attr.width]="node.size.width"
          [attr.height]="node.size.height - 16"
          [attr.fill]="node.fillColor"
          [attr.stroke]="node.borderColor"
          stroke-width="2">
        </rect>
        <!-- Database cylinder - top ellipse (smaller) -->
        <ellipse
          [attr.cx]="node.position.x + node.size.width / 2"
          [attr.cy]="node.position.y + 8"
          [attr.rx]="node.size.width / 3"
          [attr.ry]="8"
          [attr.fill]="node.fillColor"
          [attr.stroke]="node.borderColor"
          stroke-width="2">
        </ellipse>
        <!-- Horizontal lines for database tapes -->
        <line
          *ngFor="let i of [1,2,3]"
          [attr.x1]="node.position.x"
          [attr.y1]="node.position.y + 8 + (node.size.height - 16) * i / 4"
          [attr.x2]="node.position.x + node.size.width"
          [attr.y2]="node.position.y + 8 + (node.size.height - 16) * i / 4"
          [attr.stroke]="node.borderColor"
          stroke-width="1">
        </line>
      </g>

      <!-- Resize handles -->
      <circle
        *ngIf="state.selectedNodeId === node.id"
        [attr.cx]="node.position.x + node.size.width"
        [attr.cy]="node.position.y + node.size.height"
        r="4"
        class="resize-handle"
        (mousedown)="startResize($event, node, 'se')"
        style="cursor: nw-resize;">
      </circle>

      <!-- Node name -->
      <text
        [attr.x]="node.position.x + node.size.width / 2"
        [attr.y]="getNodeTextY(node)"
        text-anchor="middle"
        [attr.dominant-baseline]="getNodeTextBaseline(node)"
        class="node-name">
        {{ node.name }}
      </text>

      <!-- Tendrils -->
      <g class="tendrils">
        <g
          *ngFor="let tendril of node.tendrils"
          class="tendril-group"
          (click)="onTendrilClick($event, node, tendril)"
          (contextmenu)="onTendrilContextMenu($event, node, tendril)">

          <!-- Tendril spring shapes -->
          <path
            *ngIf="!hasEdgeName(node.id, tendril.id)"
            [attr.d]="getTendrilSpringPath(node, tendril)"
            [attr.stroke]="tendril.type === 'incoming' ? '#4CAF50' : '#FF5722'"
            [attr.stroke-width]="tendril.borderThickness"
            fill="none"
            [attr.title]="tendril.type === 'incoming' ? 'Incoming Tendril' : 'Outgoing Tendril'"
            class="tendril">
          </path>

          <!-- Tendril name - only show if no connected edge has a name -->
          <text
            *ngIf="!hasEdgeName(node.id, tendril.id)"
            [attr.x]="tendril.type === 'incoming' ? node.position.x + tendril.position.x - 25 : node.position.x + tendril.position.x + 25"
            [attr.y]="node.position.y + tendril.position.y - 8"
            [attr.text-anchor]="tendril.type === 'incoming' ? 'end' : 'start'"
            dominant-baseline="middle"
            class="tendril-name">
            {{ tendril.name }}
          </text>
        </g>
      </g>
    </g>
  </g>

  <!-- Arrow marker, grid pattern, and drop shadow filter definitions -->
  <defs>
    <marker
      id="arrowhead"
      markerWidth="10"
      markerHeight="7"
      refX="9"
      refY="3.5"
      orient="auto">
      <polygon
        points="0 0, 10 3.5, 0 7"
        fill="#666" />
    </marker>

    <pattern
      id="grid"
      width="20"
      height="20"
      patternUnits="userSpaceOnUse">
      <circle
        cx="10"
        cy="10"
        r="1"
        fill="#cccccc">
      </circle>
    </pattern>

    <filter
      id="dropshadow"
      x="-20%"
      y="-20%"
      width="140%"
      height="140%">
      <feDropShadow
        dx="3"
        dy="3"
        stdDeviation="2"
        flood-color="#000000"
        flood-opacity="0.3"/>
    </filter>

    <filter
      id="glow"
      x="-50%"
      y="-50%"
      width="200%"
      height="200%">
      <feGaussianBlur
        stdDeviation="3"
        result="coloredBlur"/>
      <feMerge>
        <feMergeNode in="coloredBlur"/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>
  </defs>
</svg>
</div>
