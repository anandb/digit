<svg
  #canvas
  class="diagram-canvas"
  width="100%"
  height="100%"
  (click)="onCanvasClick($event)">

  <!-- Grid background -->
  <rect
    width="100%"
    height="100%"
    fill="url(#grid)">
  </rect>

  <!-- Edges -->
  <g class="edges">
    <path
      *ngFor="let edge of state.currentDiagram.edges"
      [attr.d]="getEdgePath(edge)"
      class="edge"
      stroke="#666"
      stroke-width="2"
      fill="none"
      marker-end="url(#arrowhead)">
    </path>
  </g>

  <!-- Temporary edge during creation -->
  <path
    *ngIf="isCreatingEdge"
    [attr.d]="getTempEdgePath()"
    class="temp-edge"
    stroke="#999"
    stroke-width="2"
    stroke-dasharray="5,5"
    fill="none">
  </path>

  <!-- Nodes -->
  <g class="nodes">
    <g
      *ngFor="let node of state.currentDiagram.nodes"
      class="node-group"
      cdkDrag
      (cdkDragEnded)="onNodeDragEnd($event, node)"
      (dblclick)="onNodeDoubleClick(node)"
      (contextmenu)="onNodeContextMenu($event, node)">

      <!-- Node rectangle -->
      <rect
        [attr.x]="node.position.x"
        [attr.y]="node.position.y"
        [attr.width]="node.size.width"
        [attr.height]="node.size.height"
        [attr.fill]="node.fillColor"
        [attr.stroke]="node.borderColor"
        stroke-width="2"
        class="node">
      </rect>

      <!-- Resize handles -->
      <circle
        *ngIf="state.selectedNodeId === node.id"
        [attr.cx]="node.position.x + node.size.width"
        [attr.cy]="node.position.y + node.size.height"
        r="4"
        class="resize-handle"
        (mousedown)="startResize($event, node, 'se')"
        style="cursor: nw-resize;">
      </circle>

      <!-- Node name -->
      <text
        [attr.x]="node.position.x + node.size.width / 2"
        [attr.y]="node.position.y + node.size.height / 2"
        text-anchor="middle"
        dominant-baseline="middle"
        class="node-name">
        {{ node.name }}
      </text>

      <!-- Tendrils -->
      <g class="tendrils">
        <g
          *ngFor="let tendril of node.tendrils"
          class="tendril-group"
          (click)="onTendrilClick($event, node, tendril)"
          (contextmenu)="onTendrilContextMenu($event, node, tendril)">

          <!-- Tendril circle -->
          <circle
            [attr.cx]="node.position.x + tendril.position.x"
            [attr.cy]="node.position.y + tendril.position.y"
            r="6"
            [attr.fill]="tendril.type === 'incoming' ? '#4CAF50' : '#FF5722'"
            [attr.stroke]="tendril.borderColor"
            [attr.stroke-width]="tendril.borderThickness"
            [attr.title]="tendril.type === 'incoming' ? 'Incoming Tendril' : 'Outgoing Tendril'"
            class="tendril">
          </circle>

          <!-- Tendril name -->
          <text
            [attr.x]="tendril.type === 'incoming' ? node.position.x + tendril.position.x - 25 : node.position.x + tendril.position.x + 25"
            [attr.y]="node.position.y + tendril.position.y - 8"
            [attr.text-anchor]="tendril.type === 'incoming' ? 'end' : 'start'"
            dominant-baseline="middle"
            class="tendril-name">
            {{ tendril.name }}
          </text>
        </g>
      </g>
    </g>
  </g>

  <!-- Arrow marker and grid pattern definitions -->
  <defs>
    <marker
      id="arrowhead"
      markerWidth="10"
      markerHeight="7"
      refX="9"
      refY="3.5"
      orient="auto">
      <polygon
        points="0 0, 10 3.5, 0 7"
        fill="#666" />
    </marker>

    <pattern
      id="grid"
      width="20"
      height="20"
      patternUnits="userSpaceOnUse">
      <circle
        cx="10"
        cy="10"
        r="1"
        fill="#cccccc">
      </circle>
    </pattern>
  </defs>
</svg>
